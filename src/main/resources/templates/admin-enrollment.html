<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>BMW-SIS Admin - Enrollment Management</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" th:href="@{/css/admin-style.css?v=3.0}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" th:src="@{/js/admin-main.js}"></script>
    <style>
        /* Enhanced styles for student enrollment cards */
        .status-enrolled { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-dropped { background: #f8d7da; color: #721c24; }
        .enrollment-item.pending { border-left-color: #ffc107; }
        .enrollment-item.dropped { border-left-color: #dc3545; opacity: 0.7; }
        .enrollment-item:hover { background: #e9ecef !important; transform: translateX(4px); }
        .student-enrollment-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important; transform: translateY(-2px); }
        .expand-icon.rotated { transform: rotate(180deg) !important; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; position: relative; }
        .close { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close:hover { color: #000; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="profile-section">
            <div class="profile-avatar">
                <img src="/BMWlogo.png" alt="BMW Logo" style="width: 60px; height: 60px; border-radius: 50%; object-fit: contain; background: white; padding: 8px;"/>
            </div>
            <div class="profile-name" th:text="${admin.firstName + ' ' + admin.lastName}">Administrator</div>
            <div class="profile-role">System Administrator</div>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Main Navigation</div>
            <div class="nav-buttons">
                <a href="/admin/dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/simple-students">
                    <i class="fas fa-user-graduate"></i>
                    <span>Students</span>
                </a>
                <a href="/admin/faculty">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Faculty</span>
                </a>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">Academic Management</div>
            <div class="nav-buttons">
                <a href="/admin/programs">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Programs</span>
                </a>
                <a href="/admin/subjects">
                    <i class="fas fa-book"></i>
                    <span>Subjects</span>
                </a>
                <a href="/admin/schedules">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Schedules</span>
                </a>
                <a href="/admin/curriculum">
                    <i class="fas fa-list-alt"></i>
                    <span>Curriculum</span>
                </a>
                <a href="/admin/sections">
                    <i class="fas fa-building"></i>
                    <span>Sections</span>
                </a>
                <a href="/admin/enrollment" class="active">
                    <i class="fas fa-user-plus"></i>
                    <span>Enrollment</span>
                </a>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-section-title">System</div>
            <div class="nav-buttons">
                <a href="/admin/settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </div>
        
        <a href="/admin/logout" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-user-plus"></i> Enrollment Management</h1>
            <button class="btn btn-primary" onclick="openAddEnrollmentModal()"><i class="fas fa-plus"></i> Add New Enrollment</button>
        </div>
        
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" th:text="${enrollments != null ? enrollments.size() : 0}">0</div>
                    <div class="stat-label">Total Enrollments</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="activeEnrollments">0</div>
                    <div class="stat-label">Active Enrollments</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="pendingEnrollments">0</div>
                    <div class="stat-label">Pending Enrollments</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="droppedEnrollments">0</div>
                    <div class="stat-label">Dropped Enrollments</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Enrollment Records</h2>
            
            <!-- Add Curriculum Package Assignment Section -->
            <div class="section" style="background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #007bff;">
                <h3><i class="fas fa-graduation-cap"></i> Curriculum Package Assignment</h3>
                <p class="text-muted">Assign curriculum packages to students. Students will see subjects from their assigned packages as available options for enrollment in their portal, allowing them to choose which subjects to take.</p>
                
                <!-- Enrollment Period Management -->
                <div style="background: #fff3cd; padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4><i class="fas fa-clock"></i> Enrollment Period Management</h4>
                    <p class="text-muted">If students see "Enrollment is currently CLOSED", you need to create an active enrollment period.</p>
                    <form method="post" action="/admin/enrollment/create-default-period" style="display: inline;">
                        <button type="submit" class="btn btn-warning" onclick="return confirm('This will create a 30-day enrollment period starting now. Continue?')">
                            <i class="fas fa-calendar-plus"></i> Create Default Enrollment Period
                        </button>
                    </form>
                </div>
                
                <form id="curriculumAssignmentForm" method="post" action="/admin/enrollment/assign-curriculum" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
                    <div class="form-group" style="min-width: 250px;">
                        <label for="assignStudentId">Select Student:</label>
                        <select id="assignStudentId" name="studentId" required>
                            <option value="">Select Student</option>
                            <option th:each="student : ${students}" th:value="${student.id}" 
                                    th:text="${student.studentId + ' - ' + student.firstName + ' ' + student.lastName + ' (' + student.course + ', Year ' + student.yearLevel + ')'}">
                                2024-001 - Luna Lovegood (BS Information Technology, Year 1)
                            </option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="min-width: 300px;">
                        <label for="assignCurriculumId">Select Curriculum Package:</label>
                        <select id="assignCurriculumId" name="curriculumId" required>
                            <option value="">Select Curriculum Package</option>
                            <option th:each="curriculum : ${curriculums}" th:value="${curriculum.id}" 
                                    th:text="${curriculum.curriculumCode + ' - ' + curriculum.curriculumName + ' (' + curriculum.course + ', Year ' + curriculum.yearLevel + ', Sem ' + curriculum.semester + ')'}">
                                BSIT-1Y-2S - BS IT Core Subjects (BS Information Technology, Year 1, Sem 2)
                            </option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Assign Package
                    </button>
                    
                    <button type="button" class="btn btn-info" onclick="viewCurriculumAssignments()">
                        <i class="fas fa-eye"></i> View Assignments
                    </button>
                    
                    <button type="button" class="btn btn-warning" onclick="debugCurriculumAssignment()">
                        <i class="fas fa-bug"></i> Debug Assignment
                    </button>
                </form>
                
                <div id="assignmentResult" style="margin-top: 15px;"></div>
            </div>
            
            <div class="controls">
                <input type="text" class="search-box" id="searchInput" placeholder="Search by student name, subject, or status...">
                <select class="form-control" id="statusFilter" onchange="filterByStatus()">
                    <option value="">All Status</option>
                    <option value="ENROLLED">Enrolled</option>
                    <option value="PENDING">Pending</option>
                    <option value="DROPPED">Dropped</option>
                </select>
                <select class="form-control" id="yearFilter" onchange="filterByYear()">
                    <option value="">All Years</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                </select>
                <button class="btn btn-info" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
                <button class="btn btn-success" onclick="refreshTable()"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            
            <div th:if="${enrollments.empty}" class="empty-state">
                <p>No enrollment records found.</p>
            </div>
            
            <div th:unless="${enrollments.empty}">
                <!-- Search and Filter Controls -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    <input type="text" style="flex: 1; min-width: 300px; padding: 12px 16px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;" 
                           id="searchStudentInput" placeholder="Search by student name, ID, or subject...">
                    <select style="padding: 12px 16px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; min-width: 150px;" 
                            id="statusFilterNew" onchange="filterStudentEnrollments()">
                        <option value="">All Status</option>
                        <option value="ENROLLED">Enrolled</option>
                        <option value="PENDING">Pending</option>
                        <option value="DROPPED">Dropped</option>
                    </select>
                    <select style="padding: 12px 16px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; min-width: 150px;" 
                            id="yearFilterNew" onchange="filterStudentEnrollments()">
                        <option value="">All Years</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                    <button class="btn btn-primary" onclick="expandAllStudents()">
                        <i class="fas fa-expand-arrows-alt"></i> Expand All
                    </button>
                    <button class="btn btn-secondary" onclick="collapseAllStudents()">
                        <i class="fas fa-compress-arrows-alt"></i> Collapse All
                    </button>
                </div>

                <!-- Student Enrollment Cards -->
                <div id="studentEnrollmentCards">
                    <div th:if="${studentEnrollments == null or studentEnrollments.empty}" 
                         style="text-align: center; padding: 60px 20px; color: #666; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-clipboard-list" style="font-size: 64px; color: #dee2e6; margin-bottom: 20px;"></i>
                        <h3>No Enrollment Data Found</h3>
                        <p>Students will appear here once they have enrollments assigned.</p>
                    </div>
                    
                    <div th:each="entry : ${studentEnrollments}" 
                         class="student-enrollment-card" 
                         th:data-student-id="${entry.key.id}"
                         th:data-student-name="${entry.key.firstName + ' ' + entry.key.lastName}"
                         th:data-year="${entry.key.yearLevel}"
                         th:data-course="${entry.key.course}"
                         style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; transition: all 0.3s ease; border-left: 4px solid #007bff;">
                        
                        <div class="student-card-header" onclick="toggleStudentEnrollments(this)" 
                             style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #007bff, #0056b3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;"
                                     th:text="${entry.key.firstName.substring(0,1) + entry.key.lastName.substring(0,1)}">JD</div>
                                <div>
                                    <h3 style="margin: 0; color: #333; font-size: 18px;" th:text="${entry.key.firstName + ' ' + entry.key.lastName}">John Doe</h3>
                                    <div style="color: #666; font-size: 14px; margin-top: 4px;">
                                        <span th:text="${entry.key.studentId}">2024-001</span> • 
                                        <span th:text="${entry.key.course}">Information Technology</span> • 
                                        Year <span th:text="${entry.key.yearLevel}">1</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div style="background: #007bff; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500;" 
                                     th:text="${entry.value.size() + ' enrollment' + (entry.value.size() != 1 ? 's' : '')}">3 enrollments</div>
                                <i class="fas fa-chevron-down expand-icon" style="transition: transform 0.3s ease; color: #007bff; font-size: 20px;"></i>
                            </div>
                        </div>
                        
                        <div class="student-enrollments" style="display: none; padding: 0 20px 20px 20px;">
                            <div th:if="${entry.value.empty}" style="text-align: center; color: #666; font-style: italic; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 10px 0;">
                                No enrollments found for this student.
                            </div>
                            
                            <div th:each="enrollment : ${entry.value}" 
                                 class="enrollment-item"
                                 style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #28a745; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease;"
                                 th:classappend="${enrollment.status.toLowerCase()}"
                                 th:data-status="${enrollment.status}">
                                
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #333; font-size: 16px;" th:text="${enrollment.subject != null ? enrollment.subject.subjectCode : 'N/A'}">IT-101</div>
                                    <div style="color: #666; font-size: 14px; margin-top: 4px;" th:text="${enrollment.subject != null ? enrollment.subject.subjectName : 'Unknown Subject'}">Introduction to Programming</div>
                                    <div style="color: #666; font-size: 13px; margin-top: 6px;">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span th:text="${enrollment.subjectSchedule != null ? (enrollment.subjectSchedule.dayOfWeek + ' ' + enrollment.subjectSchedule.startTime + '-' + enrollment.subjectSchedule.endTime) : 'No schedule'}">Monday 8:00-11:00</span>
                                        <span th:if="${enrollment.subjectSchedule != null and enrollment.subjectSchedule.room != null}">
                                            • <i class="fas fa-door-open"></i> <span th:text="${enrollment.subjectSchedule.room}">Room 101</span>
                                        </span>
                                        <span th:if="${enrollment.subjectSchedule != null and enrollment.subjectSchedule.faculty != null}">
                                            • <i class="fas fa-user-tie"></i> <span th:text="${enrollment.subjectSchedule.faculty.firstName + ' ' + enrollment.subjectSchedule.faculty.lastName}">Dr. Smith</span>
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="status-badge" 
                                          style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; text-transform: uppercase;"
                                          th:classappend="'status-' + ${enrollment.status.toLowerCase()}"
                                          th:text="${enrollment.status}">ENROLLED</span>
                                    
                                    <div style="display: flex; gap: 8px;">
                                        <button style="width: 36px; height: 36px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; font-size: 14px; background: #17a2b8; color: white;" 
                                                th:onclick="'editEnrollment(' + ${enrollment.id} + ')'"
                                                title="Edit Enrollment">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button style="width: 36px; height: 36px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; font-size: 14px; background: #dc3545; color: white;" 
                                                th:onclick="'deleteEnrollment(' + ${enrollment.id} + ')'"
                                                title="Delete Enrollment">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Old table view (hidden by default, can be toggled) -->
                <div id="tableView" style="display: none; overflow-x: auto; max-height: 600px;">
                    <table id="enrollmentsTable">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Subject</th>
                                <th>Schedule</th>
                                <th>Faculty</th>
                                <th>Enrollment Date</th>
                                <th>Status</th>
                                <th>Year Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="enrollment : ${enrollments}" th:data-status="${enrollment.status}" th:data-year="${enrollment.student.yearLevel}">
                                <td>
                                    <div th:text="${enrollment.student.firstName + ' ' + enrollment.student.lastName}">John Doe</div>
                                    <small th:text="${enrollment.student.studentId}">2024-001</small>
                                </td>
                                <td>
                                    <div th:text="${enrollment.subject != null ? enrollment.subject.subjectCode : 'N/A'}">IT-101</div>
                                    <small th:text="${enrollment.subject != null ? enrollment.subject.subjectName : 'N/A'}">Programming</small>
                                </td>
                                <td>
                                    <div th:text="${enrollment.subjectSchedule != null ? (enrollment.subjectSchedule.dayOfWeek + ' ' + enrollment.subjectSchedule.startTime + '-' + enrollment.subjectSchedule.endTime) : 'N/A'}">Mon 8:00-11:00</div>
                                    <small th:text="${enrollment.subjectSchedule != null ? enrollment.subjectSchedule.room : 'N/A'}">Room 101</small>
                                </td>
                                <td th:text="${enrollment.subjectSchedule != null and enrollment.subjectSchedule.faculty != null ? enrollment.subjectSchedule.faculty.firstName + ' ' + enrollment.subjectSchedule.faculty.lastName : 'N/A'}">Dr. Smith</td>
                                <td th:text="${#temporals.format(enrollment.enrollmentDate, 'yyyy-MM-dd')}">2024-01-15</td>
                                <td>
                                    <span class="badge" 
                                          th:classappend="${enrollment.status == 'ENROLLED'} ? 'badge-success' : (${enrollment.status == 'PENDING'} ? 'badge-warning' : 'badge-danger')"
                                          th:text="${enrollment.status}">ENROLLED</span>
                                </td>
                                <td th:text="${enrollment.student.yearLevel}">1</td>
                                <td>
                                    <button class="btn btn-info btn-sm" th:onclick="'viewEnrollment(' + ${enrollment.id} + ')'"><i class="fas fa-eye"></i> View</button>
                                    <button class="btn btn-primary btn-sm" th:onclick="'editEnrollment(' + ${enrollment.id} + ')'"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="btn btn-danger btn-sm" th:onclick="'deleteEnrollment(' + ${enrollment.id} + ')'"><i class="fas fa-trash"></i> Delete</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- View Toggle Button -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="toggleView()" id="toggleViewBtn">
                        <i class="fas fa-table"></i> Switch to Table View
                    </button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Quick Enrollment Actions</h2>
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="bulkApproveEnrollments()">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-label">Approve All Pending</div>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateEnrollmentReport()">
                    <div class="stat-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><i class="fas fa-chart-bar"></i></div>
                        <div class="stat-label">Generate Report</div>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="sendEnrollmentNotifications()">
                    <div class="stat-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><i class="fas fa-envelope"></i></div>
                        <div class="stat-label">Send Notifications</div>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="exportEnrollmentData()">
                    <div class="stat-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><i class="fas fa-download"></i></div>
                        <div class="stat-label">Export Data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Enrollment Modal -->
    <div id="enrollmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add New Enrollment</h2>
            <form id="enrollmentForm" method="post" th:action="@{/admin/enrollment/add}">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="studentId">Student</label>
                        <select id="studentId" name="studentId" required>
                            <option value="">Select Student</option>
                            <option th:each="student : ${students}" th:value="${student.id}" th:text="${student.studentId + ' - ' + student.firstName + ' ' + student.lastName}">2024-001 - John Doe</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="scheduleId">Schedule</label>
                        <select id="scheduleId" name="scheduleId" required>
                            <option value="">Select Schedule</option>
                            <option th:each="schedule : ${schedules}" 
                                    th:value="${schedule.id}" 
                                    th:text="${(schedule.subject != null ? schedule.subject.subjectCode : 'N/A') + ' - ' + schedule.dayOfWeek + ' ' + schedule.startTime + ' (' + schedule.sectionCode + ')'}">IT-101 - Mon 8:00 (IT-1A)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="enrollmentDate">Enrollment Date</label>
                        <input type="date" id="enrollmentDate" name="enrollmentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status" required>
                            <option value="">Select Status</option>
                            <option value="ENROLLED">Enrolled</option>
                            <option value="PENDING">Pending</option>
                            <option value="DROPPED">Dropped</option>
                            <option value="WAITLISTED">Waitlisted</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" name="remarks" rows="3" placeholder="Additional notes or remarks..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Enrollment</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        $(document).ready(function() {
            calculateEnrollmentStats();
            
            // Set today's date as default for enrollment date
            $('#enrollmentDate').val(new Date().toISOString().split('T')[0]);
        });
        
        function openAddEnrollmentModal() {
            $('#modalTitle').text('Add New Enrollment');
            $('#enrollmentForm').attr('action', '/admin/enrollment/add');
            $('#enrollmentForm')[0].reset();
            $('#enrollmentDate').val(new Date().toISOString().split('T')[0]);
            $('#enrollmentModal').show();
        }
        
        function viewEnrollment(id) {
            // Implementation for viewing enrollment details
            alert('View enrollment functionality - ID: ' + id);
        }
        
        function editEnrollment(id) {
            $('#modalTitle').text('Edit Enrollment');
            $('#enrollmentForm').attr('action', '/admin/enrollment/update/' + id);
            // Fetch and populate enrollment data
            $('#enrollmentModal').show();
        }
        
        function deleteEnrollment(id) {
            if (confirm('Are you sure you want to delete this enrollment record?')) {
                $.ajax({
                    url: '/admin/enrollment/delete/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        alert('Enrollment deleted successfully!');
                        // Refresh the page to show updated data
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('Error deleting enrollment: ' + xhr.responseText);
                    }
                });
            }
        }
        
        function filterByStatus() {
            const status = $('#statusFilter').val();
            const rows = $('#enrollmentsTable tbody tr');
            
            rows.each(function() {
                if (status === '' || $(this).data('status') === status) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
        function filterByYear() {
            const year = $('#yearFilter').val();
            const rows = $('#enrollmentsTable tbody tr');
            
            rows.each(function() {
                if (year === '' || $(this).data('year') == year) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
        
        function calculateEnrollmentStats() {
            const rows = $('#enrollmentsTable tbody tr');
            let active = 0, pending = 0, dropped = 0;
            
            if (rows.length > 0) {
                rows.each(function() {
                    const status = $(this).data('status');
                    switch(status) {
                        case 'ENROLLED':
                            active++;
                            break;
                        case 'PENDING':
                            pending++;
                            break;
                        case 'DROPPED':
                            dropped++;
                            break;
                    }
                });
            }
            
            $('#activeEnrollments').text(active);
            $('#pendingEnrollments').text(pending);
            $('#droppedEnrollments').text(dropped);
            
            // Add loaded class to animate cards
            $('.stat-card').addClass('loaded');
        }
        
        function bulkApproveEnrollments() {
            if (confirm('Are you sure you want to approve all pending enrollments?')) {
                // Implementation for bulk approval
                alert('Bulk approve functionality will be implemented');
            }
        }
        
        function generateEnrollmentReport() {
            // Implementation for generating reports
            alert('Report generation functionality will be implemented');
        }
        
        function sendEnrollmentNotifications() {
            // Implementation for sending notifications
            alert('Notification functionality will be implemented');
        }
        
        function exportEnrollmentData() {
            // Implementation for data export
            alert('Data export functionality will be implemented');
        }
        
        function debugCurriculumAssignment() {
            const curriculumId = $('#assignCurriculumId').val();
            if (!curriculumId) {
                alert('Please select a curriculum package first');
                return;
            }
            
            // Open debug page in new tab
            window.open('/admin/curriculum-assignment-debug/' + curriculumId, '_blank');
        }
        
        function viewCurriculumAssignments() {
            alert('View assignments functionality will be implemented');
        }
        
        // Search functionality
        $('#searchInput').on('keyup', function() {
            const searchValue = $(this).val().toLowerCase();
            const rows = $('#enrollmentsTable tbody tr');
            
            rows.each(function() {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(searchValue));
            });
        });
        
        // New functions for student-organized view
        function toggleStudentEnrollments(header) {
            const card = header.closest('.student-enrollment-card');
            const enrollments = card.querySelector('.student-enrollments');
            const icon = header.querySelector('.expand-icon');
            
            if (enrollments.style.display === 'none' || enrollments.style.display === '') {
                enrollments.style.display = 'block';
                icon.classList.add('rotated');
                icon.style.transform = 'rotate(180deg)';
            } else {
                enrollments.style.display = 'none';
                icon.classList.remove('rotated');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function expandAllStudents() {
            document.querySelectorAll('.student-enrollments').forEach(enrollments => {
                enrollments.style.display = 'block';
            });
            document.querySelectorAll('.expand-icon').forEach(icon => {
                icon.classList.add('rotated');
                icon.style.transform = 'rotate(180deg)';
            });
        }
        
        function collapseAllStudents() {
            document.querySelectorAll('.student-enrollments').forEach(enrollments => {
                enrollments.style.display = 'none';
            });
            document.querySelectorAll('.expand-icon').forEach(icon => {
                icon.classList.remove('rotated');
                icon.style.transform = 'rotate(0deg)';
            });
        }
        
        function filterStudentEnrollments() {
            const searchValue = $('#searchStudentInput').val().toLowerCase();
            const statusFilter = $('#statusFilterNew').val();
            const yearFilter = $('#yearFilterNew').val();
            
            $('.student-enrollment-card').each(function() {
                const card = $(this);
                const studentName = card.data('student-name').toLowerCase();
                const studentId = card.attr('data-student-id');
                const year = card.data('year').toString();
                const course = card.data('course');
                
                let showCard = true;
                
                // Search filter
                if (searchValue && !studentName.includes(searchValue) && !studentId.includes(searchValue)) {
                    // Also check subjects in enrollments
                    const hasMatchingSubject = card.find('.enrollment-item').toArray().some(item => 
                        $(item).text().toLowerCase().includes(searchValue)
                    );
                    if (!hasMatchingSubject) {
                        showCard = false;
                    }
                }
                
                // Year filter
                if (yearFilter && year !== yearFilter) {
                    showCard = false;
                }
                
                // Status filter - check if any enrollment matches
                if (statusFilter) {
                    const hasMatchingStatus = card.find('.enrollment-item[data-status="' + statusFilter + '"]').length > 0;
                    if (!hasMatchingStatus) {
                        showCard = false;
                    }
                }
                
                card.toggle(showCard);
            });
        }
        
        function toggleView() {
            const cardView = $('#studentEnrollmentCards');
            const tableView = $('#tableView');
            const toggleBtn = $('#toggleViewBtn');
            
            if (cardView.is(':visible')) {
                cardView.hide();
                tableView.show();
                toggleBtn.html('<i class="fas fa-th-large"></i> Switch to Card View');
            } else {
                tableView.hide();
                cardView.show();
                toggleBtn.html('<i class="fas fa-table"></i> Switch to Table View');
            }
        }
        
        // Search functionality for new view
        $('#searchStudentInput').on('keyup', function() {
            filterStudentEnrollments();
        });
        
        // Close modal function
        function closeModal() {
            $('#enrollmentModal').hide();
        }
        
        // Close modal when clicking outside
        $(window).click(function(event) {
            if (event.target.classList.contains('modal')) {
                $(event.target).hide();
            }
        });
    </script>
</body>
</html> 